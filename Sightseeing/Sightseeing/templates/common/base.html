{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Karla:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet">
    <title>{% block title %}{% endblock title %}</title>
    <link rel="stylesheet" href="{% static 'base.css' %}">
    <link rel="stylesheet" href="{% static 'navbar.css' %}">
    <link rel="stylesheet" href="{% static 'footer.css' %}?v=3">
    {% block extra_css %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">
    {% block navbar %}
        {% include "common/navbar.html" %}
    {% endblock %}

    <main>
        {% block content %}{% endblock %}
    </main>

    {% block footer %}
        {% include "common/footer.html" %}
    {% endblock %}

    {% block extra_js %}{% endblock %}

    <!-- SETTINGS MODAL – ĐỔI MÀU NAVBAR + FOOTER + BACKGROUND (GIỮ NGUYÊN GIAO DIỆN ĐẸP) -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-content">
            <div class="settings-header">
                <h3>Settings</h3>
                <span class="close-modal">×</span>
            </div>
            <div class="setting-item">
                <label>Navbar Color</label>
                <div class="color-picker-box">
                    <input type="color" id="navbar-picker" value="#ffffff">
                    <span id="navbar-hex">#ffffff</span>
                </div>
            </div>
            <div class="setting-item">
                <label>Footer Color</label>
                <div class="color-picker-box">
                    <input type="color" id="footer-picker" value="#1a1a1a">
                    <span id="footer-hex">#1a1a1a</span>
                </div>
            </div>
            <div class="setting-item">
                <label>Background Color</label>
                <div class="color-picker-box">
                    <input type="color" id="bg-picker" value="#f6f7f2">
                    <span id="bg-hex">#f6f7f2</span>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Modal không làm tối nền */
        .settings-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            inset: 0;
            background: transparent;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .settings-content {
            pointer-events: auto;
            background: #1a1a1a;
            color: white;
            padding: 32px;
            border-radius: 24px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 14px;
            border-bottom: 1px solid #444;
        }

        .close-modal {
            font-size: 32px;
            cursor: pointer;
            color: #ccc;
        }

            .close-modal:hover {
                color: white;
            }

        .setting-item label {
            display: block;
            margin-bottom: 12px;
            font-size: 15px;
            font-weight: 600;
            color: #ddd;
        }

        .color-picker-box {
            display: flex;
            align-items: center;
            gap: 18px;
            background: rgba(255,255,255,0.08);
            padding: 18px;
            border-radius: 18px;
        }

        input[type="color"] {
            -webkit-appearance: none;
            width: 100px;
            height: 100px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            transition: transform 0.2s;
        }

            input[type="color"]:hover {
                transform: scale(1.1);
            }

            input[type="color"]::-webkit-color-swatch-wrapper {
                padding: 0;
            }

            input[type="color"]::-webkit-color-swatch {
                border: none;
                border-radius: 50%;
            }

        #navbar-hex, #footer-hex, #bg-hex {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            background: rgba(255,255,255,0.15);
            padding: 10px 18px;
            border-radius: 12px;
            min-width: 120px;
            text-align: center;
            letter-spacing: 1px;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modal    = document.getElementById('settings-modal');
            const openBtn  = document.getElementById('open-settings-modal');
            const closeBtn = document.querySelector('.close-modal');

            const navbar   = document.querySelector('.navbar');
            const footer   = document.getElementById('site-footer');
            const body     = document.body;

            // LẤY USER ID TỪ DJANGO — QUAN TRỌNG NHẤT!
            const userId   = "{{ request.user.id|default:'guest' }}";
            const storageKey = `gost_theme_v2_${userId}`;

            // Lấy màu gốc từ CSS (chuẩn 100%)
            const getOriginal = el => getComputedStyle(el).backgroundColor;

            const originalColors = {
                navbar: getOriginal(navbar),
                footer: getOriginal(footer),
                background: getOriginal(body)
            };

            // Lấy theme đã lưu của user này (nếu có)
            let theme = originalColors;
            if (userId !== 'guest') {
                const saved = localStorage.getItem(storageKey);
                if (saved) theme = JSON.parse(saved);
            }

            // Hàm chuyển RGB → HEX
            const rgbToHex = rgb => {
                if (rgb.startsWith('#')) return rgb.toUpperCase();
                const nums = rgb.match(/\d+/g);
                if (!nums) return '#FFFFFF';
                const [r, g, b] = nums.map(Number);
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
            };

            // Áp dụng theme
            navbar.style.backgroundColor = theme.navbar;
            footer.style.backgroundColor = theme.footer;
            body.style.backgroundColor   = theme.background;

            // Cập nhật picker + hiển thị HEX
            document.getElementById('navbar-picker').value = rgbToHex(theme.navbar);
            document.getElementById('footer-picker').value = rgbToHex(theme.footer);
            document.getElementById('bg-picker').value     = rgbToHex(theme.background);

            document.getElementById('navbar-hex').textContent = document.getElementById('navbar-picker').value;
            document.getElementById('footer-hex').textContent = document.getElementById('footer-picker').value;
            document.getElementById('bg-hex').textContent     = document.getElementById('bg-picker').value;

            // Lưu theme khi thay đổi
            const saveTheme = () => {
                if (userId !== 'guest') {
                    localStorage.setItem(storageKey, JSON.stringify({
                        navbar: navbar.style.backgroundColor,
                        footer: footer.style.backgroundColor,
                        background: body.style.backgroundColor
                    }));
                }
            };

            // Mở/đóng modal
            openBtn?.addEventListener('click', e => { e.preventDefault(); modal.style.display = 'flex'; });
            closeBtn?.addEventListener('click', () => modal.style.display = 'none');
            window.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });

            // Thay đổi màu realtime + lưu
            document.getElementById('navbar-picker').addEventListener('input', e => {
                navbar.style.backgroundColor = e.target.value;
                document.getElementById('navbar-hex').textContent = e.target.value;
                saveTheme();
            });

            document.getElementById('footer-picker').addEventListener('input', e => {
                footer.style.backgroundColor = e.target.value;
                document.getElementById('footer-hex').textContent = e.target.value;
                saveTheme();
            });

            document.getElementById('bg-picker').addEventListener('input', e => {
                body.style.backgroundColor = e.target.value;
                document.getElementById('bg-hex').textContent = e.target.value;
                saveTheme();
            });
        });
    </script>
</body>
</html>